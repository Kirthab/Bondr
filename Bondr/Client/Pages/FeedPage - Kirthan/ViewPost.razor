@page "/post/viewpost/{postId}"

@inject NavigationManager _navManager
@inject HttpClient _client
@inject HttpInterceptorService _interceptor
@implements IDisposable

<div id="container">
    <div id="top">
        <div id="post-container">
           <h4 id="username">#Username</h4>
            @if (Post != null)
            {
                <h1 id="title">@Post.Title</h1>
                <p id="content">@Post.Content</p>
                <div id="post-buttons">
                    <button id="arrow-button" @onclick="Upvote">&#129093;</button>
                    <p id="vote-count">@Post.Vote</p>
                    <button id="arrow-button" @onclick="Downvote">&#x1F847;</button>
                    <button id="add-comment" @onclick="ToggleDropdown" >Add Comment &#43;</button>
                </div>
            }
            else
            {
                <p>No content here</p>
            }
        </div>
    </div>
    @if (ShowDiv)
    {
        <EditForm Model="@comment" OnValidSubmit="CreateComment">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="collapsible-create-comment">
                <textarea class="comment-para" @bind="comment.Text" placeholder="Enter Comment (2000 characters max)" maxlength="2000"></textarea>
                <button type="submit" id="upload-comment">Submit</button>
            </div>
        </EditForm>
    }
    <div id="comments-container">
        @if (Comments == null || !Comments.Any())
        {
            <br />
            <div id="no-comments">No comments here. Be the first to add one!</div>
            <br />
        }
        else
        {
            <table>
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Vote</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var comment in DisplayedComments)
                    {
                        <tr>
                            <td>@comment.Text</td>
                            <td>@comment.Vote</td>
                        </tr>
                    }
                </tbody>
            </table>
            
            <div class="pagination">
                <button disabled="@IsFirstPage" class="page-button" @onclick="PreviousPage">&#x21E0; Back</button>
                <span>Page @currentPage of @totalPages</span>
                <button disabled="@IsLastPage" class="page-button" @onclick="NextPage">Next &#x21E2;</button>
            </div>
            <br />
        }

    </div>
</div>

@code {
    [Parameter] public string postId { get; set; }
    private Post Post;
    Comment comment = new Comment();

    private List<Comment>? Comments;
    private List<Comment>? AllComments;
    private List<Comment> DisplayedComments;
    private string newCommentText;
    private bool ShowDiv = false;

    private int commentsPerPage = 20;
    private int currentPage = 1;
    private int totalPages => (int)Math.Ceiling((double)(Comments?.Count ?? 0) / commentsPerPage);
    private bool IsFirstPage => currentPage == 1;
    private bool IsLastPage => currentPage == totalPages;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Use postId to construct the URL for the specific post
            string postUrl = $"{Endpoints.PostEndpoint}/{postId}";
            Post = await _client.GetFromJsonAsync<Post>(postUrl);

        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching post: {ex.Message}");
        }

        try
        {
            AllComments = await _client.GetFromJsonAsync<List<Comment>>(Endpoints.CommentsEndpoint);
            Comments = new List<Comment>();

            foreach (var item in AllComments)
            {
                if (item.PostId == Post.Id)
                {
                    Comments.Add(item);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching comments: {ex.Message}");
            Comments = new List<Comment>();
        }
    }

    private void PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            UpdateDisplayedComments();
        }
    }

    private void NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            UpdateDisplayedComments();
        }
    }

    private void UpdateDisplayedComments()
    {
        int startIndex = (currentPage - 1) * commentsPerPage;
        DisplayedComments = Comments?.Skip(startIndex).Take(commentsPerPage).ToList() ?? new List<Comment>();
    }

    protected override void OnParametersSet()
    {
        UpdateDisplayedComments();
    }

    private void ToggleDropdown()
    {
        ShowDiv = !ShowDiv;
    }

    public void Dispose()
    {
        _interceptor.DisposeEvent();
    }

    private async Task Upvote()
    {
        Post.Vote = Post.Vote + 1;
    }

    private async Task Downvote()
    {
        Post.Vote = Post.Vote - 1;
    }

    private async Task CreateComment()
    {
        comment.Vote = 0;
        comment.PostId = Post.Id;

        try
        {
            await _client.PostAsJsonAsync(Endpoints.CommentsEndpoint, comment);

            // Append the new comment to the existing list
            Comments.Add(comment);
            comment = new Comment();

            // Update displayed comments
            UpdateDisplayedComments();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating comment: {ex.Message}");
        }
    }

}
